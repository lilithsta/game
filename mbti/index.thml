<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ€æ„›ç‰ˆ MBTI æ¸¬è©¦</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --card:#111827ee; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22d3ee; /* cyan-400 */
      --accent2:#a78bfa; /* violet-400 */
      --ok:#34d399; /* emerald-400 */
      --warn:#fb7185; /* rose-400 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 70% -10%, #1e293b 0%, var(--bg) 60%), linear-gradient(180deg, #0b1020, #0f172a);
      color:var(--text);
      display:flex; align-items:center; justify-content:center;
    }
    .app{ width:min(100%, 980px); padding:24px; }
    .card{ background:var(--card); backdrop-filter: blur(6px); border:1px solid rgba(255,255,255,.06); border-radius:20px; overflow:hidden; box-shadow: 0 10px 40px rgba(0,0,0,.4); }
    header{ padding:22px 24px; border-bottom:1px solid rgba(255,255,255,.06); display:flex; gap:16px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    h1{ font-size:clamp(20px, 3vw, 28px); margin:0; letter-spacing:.4px }
    .badges{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .badge{ font-size:12px; color:#0b1220; background:linear-gradient(120deg, var(--accent), var(--accent2)); padding:6px 10px; border-radius:999px; }
    .content{ padding:20px }
    .row{ display:grid; grid-template-columns: 1.1fr .9fr; gap:18px }
    @media (max-width:900px){ .row{ grid-template-columns:1fr } }
    .panel{ background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:18px }
    .intro p{ color:var(--muted); margin:8px 0 0 }
    .controls{ display:flex; gap:10px; flex-wrap:wrap }
    button, .linkbtn{
      background:linear-gradient(120deg, rgba(34,211,238,.12), rgba(167,139,250,.12));
      color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:12px;
      padding:10px 14px; cursor:pointer; font-weight:600;
    }
    button:hover, .linkbtn:hover{ border-color: rgba(255,255,255,.24) }
    button.ghost{ background:transparent }
    .progress{ height:8px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid rgba(255,255,255,.08); }
    .progress>div{ height:100%; background:linear-gradient(90deg, var(--accent), var(--accent2)); width:0% }
    .q{ margin:14px 0; padding:14px; border:1px solid rgba(255,255,255,.08); border-radius:14px; background:rgba(0,0,0,.16) }
    .q h3{ margin:0 0 8px; font-size:16px }
    .opt{ display:flex; gap:10px; margin-top:8px; flex-wrap:wrap }
    .opt label{ display:flex; align-items:center; gap:8px; background:rgba(255,255,255,.04); padding:10px 12px; border-radius:10px; cursor:pointer; border:1px solid rgba(255,255,255,.06) }
    .opt input{ width:16px; height:16px }
    .muted{ color:var(--muted); font-size:13px }
    .typebox{ display:grid; grid-template-columns: 1fr 1fr; gap:10px }
    .pill{ border:1px dashed rgba(255,255,255,.16); padding:6px 10px; border-radius:999px; text-align:center; font-size:13px }
    .bigtype{ font-size:40px; font-weight:900; letter-spacing:2px; text-align:center; margin:10px 0 }
    .result-card{ border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; background:rgba(255,255,255,.03) }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px }
    @media (max-width:720px){ .grid{ grid-template-columns:1fr } }
    .kvs{ display:grid; grid-template-columns: .9fr 1.1fr; gap:8px; align-items:center }
    .kv{ padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:12px }
    .hint{ font-size:12px; color:var(--muted) }
    footer{ padding:12px 18px; border-top:1px solid rgba(255,255,255,.06); display:flex; gap:10px; justify-content:space-between; flex-wrap:wrap }
    .toast{ position:fixed; right:16px; bottom:16px; padding:10px 14px; border-radius:10px; background:#101826; border:1px solid rgba(255,255,255,.1); display:none }
    a.inline{ color:var(--accent) }
  </style>
</head>
<body>
  <div class="app">
    <div class="card" id="app">
      <header>
        <h1>ğŸ’˜ æˆ€æ„›ç‰ˆ MBTI æ¸¬è©¦</h1>
        <div class="badges">
          <span class="badge">ç«‹å³ä½œç­” ~ 3-5 åˆ†é˜</span>
          <span class="badge">ç„¡éœ€ç™»å…¥</span>
        </div>
      </header>

      <div class="content">
        <div class="row">
          <section class="panel intro">
            <h2 style="margin:0">é€™æ˜¯ä»€éº¼ï¼Ÿ</h2>
            <p>æ ¹æ“š 4 å€‹ç¶­åº¦ï¼ˆå¤–å‘/å…§å‘ã€æ„Ÿè¦º/ç›´è¦ºã€æ€è€ƒ/æƒ…æ„Ÿã€åˆ¤æ–·/çŸ¥è¦ºï¼‰æ¨æ¸¬ä½ çš„æˆ€æ„›å‚¾å‘ï¼Œç”Ÿæˆ 16 å‹äººæ ¼ï¼ˆå¦‚ ENFPã€ISTJï¼‰ã€‚åƒ…ä¾›å¨›æ¨‚åƒè€ƒï½</p>
            <div class="controls" style="margin-top:10px">
              <button id="startBtn">é–‹å§‹æ¸¬è©¦</button>
              <button class="ghost" id="loadBtn">è¼‰å…¥ä¸Šæ¬¡çµæœ</button>
              <button class="ghost" id="shareBtn">åˆ†äº«æœ¬é </button>
            </div>
            <div class="muted" id="hashInfo"></div>
          </section>

          <section class="panel">
            <div class="progress" aria-label="ä½œç­”é€²åº¦"><div id="bar"></div></div>
            <div id="quiz"></div>
            <div class="controls" style="justify-content:space-between">
              <div>
                <button id="prevBtn" disabled>ä¸Šä¸€æ­¥</button>
                <button id="nextBtn" disabled>ä¸‹ä¸€æ­¥</button>
              </div>
              <button id="submitBtn" disabled>æŸ¥çœ‹çµæœ</button>
            </div>
          </section>
        </div>

        <div class="grid" style="margin-top:14px">
          <section class="result-card" id="result" hidden>
            <div class="kvs">
              <div class="kv">
                <div class="muted">ä½ çš„é¡å‹</div>
                <div class="bigtype" id="typeText">----</div>
                <div class="typebox" id="letters"></div>
              </div>
              <div class="kv">
                <div class="muted">æˆ€æ„›æ¨™ç±¤</div>
                <div class="typebox" id="tags"></div>
              </div>
            </div>
            <div style="margin-top:10px" id="desc"></div>

            <div class="panel" style="margin-top:12px">
              <h3 style="margin:0 0 8px">é©é…&äº’è£œ</h3>
              <div class="muted">æ ¹æ“šå…¸å‹äº’è£œ/åŒé »ç†è«–ç”Ÿæˆï¼Œåƒ…ä¾›åƒè€ƒã€‚</div>
              <div id="matches" style="margin-top:8px" class="typebox"></div>
            </div>

            <div class="controls" style="margin-top:12px; justify-content:space-between">
              <div>
                <button id="againBtn">å†æ¸¬ä¸€æ¬¡</button>
              </div>
              <div>
                <button id="copyLinkBtn">è¤‡è£½çµæœé€£çµ</button>
                <button id="saveBtn">å„²å­˜åˆ°æœ¬æ©Ÿ</button>
              </div>
            </div>
          </section>

          <section class="result-card">
            <h3 style="margin:0 0 8px">é—œæ–¼åˆ†æ•¸</h3>
            <p class="hint">æ¯é¡Œ 2 é¸ 1ã€‚ç³»çµ±å° 4 æ¢ç¶­åº¦åˆ†åˆ¥ç´¯è¨ˆï¼šEâ†”Iã€Sâ†”Nã€Tâ†”Fã€Jâ†”Pã€‚æ­£å‘é å·¦ã€è² å‘é å³ã€‚è‹¥æ¥è¿‘ 0ï¼Œä»£è¡¨è©²ç¶­åº¦è¼ƒå¹³è¡¡ã€‚</p>
            <div id="bars"></div>
          </section>
        </div>
      </div>

      <footer>
        <div class="muted">Â© 2025 æˆ€æ„›ç‰ˆ MBTI â€¢ ç”±ç´”å‰ç«¯å¯¦ä½œï¼ˆå¯é›¢ç·šä½¿ç”¨ï¼‰</div>
        <div class="muted">æ”¹é¡Œã€æ”¹é…è‰²æˆ–åŠ å…¥å¤šèªï¼Ÿæ­¡è¿åœ¨ç¨‹å¼è£¡èª¿æ•´ <code>QUESTIONS</code> èˆ‡ <code>TYPE_INFO</code>ã€‚</div>
      </footer>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
// ====== é¡Œåº«ï¼šæ¯é¡Œå°æ‡‰ä¸€å€‹ç¶­åº¦æ–¹å‘ ======
const QUESTIONS = [
  { id:1, dim:"EI", q:"åˆæ¬¡ç´„æœƒï¼Œä½ æœƒï¼š", a:[{t:"ä¸»å‹•å®‰æ’è¡Œç¨‹ä¸¦å¸¶å‹•æ°£æ°›", v:+1},{t:"å®‰éœè§€å¯Ÿå°æ–¹ã€æ…¢ç†±æ¼¸é€²", v:-1}]},
  { id:2, dim:"SN", q:"èŠå¤©è©±é¡Œåå¥½ï¼š", a:[{t:"å…·é«”ç”Ÿæ´»èˆ‡å¯è½åœ°è¨ˆç•«", v:+1},{t:"è…¦æ´éˆæ„Ÿèˆ‡æœªä¾†æƒ³åƒ", v:-1}]},
  { id:3, dim:"TF", q:"é¢å°è¡çªï¼Œä½ ï¼š", a:[{t:"å°±äº‹è«–äº‹ã€å…ˆè«‡é‚è¼¯èˆ‡åŸå‰‡", v:+1},{t:"å…ˆé¡§æƒ…ç·’ã€å¼·èª¿æ„Ÿå—èˆ‡é—œä¿‚", v:-1}]},
  { id:4, dim:"JP", q:"å‘Šç™½æ™‚æ©Ÿï¼š", a:[{t:"è¦åŠƒåˆ°ä½ã€é¸æ“‡åˆé©ç¯€é»", v:+1},{t:"é †å‹¢è€Œç‚ºã€æ„Ÿè¦ºåˆ°äº†å°±èªª", v:-1}]},
  { id:5, dim:"EI", q:"é€±æœ«ç›¸è™•ï¼Œä½ å‚¾å‘ï¼š", a:[{t:"ä¸€èµ·åƒåŠ æœ‹å‹èšæœƒæˆ–æˆ¶å¤–æ´»å‹•", v:+1},{t:"å…©äººä¸–ç•Œçª©å®¶è£¡æˆ–å°è€Œç¾", v:-1}]},
  { id:6, dim:"SN", q:"ç´€å¿µæ—¥ç¦®ç‰©æ›´åœ¨æ„ï¼š", a:[{t:"å¯¦ç”¨è€çœ‹ã€å€¼å¾—é•·æœŸä½¿ç”¨", v:+1},{t:"æœ‰æ•…äº‹çš„ã€è±¡å¾µæ€§çš„é©šå–œ", v:-1}]},
  { id:7, dim:"TF", q:"TA å› å·¥ä½œç…©èºæ™‚ä½ ï¼š", a:[{t:"å”åŠ©åˆ†æå•é¡Œä¸¦çµ¦æ–¹æ¡ˆ", v:+1},{t:"é™ªä¼´å‚¾è½èˆ‡æƒ…ç·’æ”¯æŒ", v:-1}]},
  { id:8, dim:"JP", q:"æ—…è¡Œé¢¨æ ¼ï¼š", a:[{t:"è¡Œç¨‹è¡¨åˆ°å°æ™‚ã€é å®šå®Œå–„", v:+1},{t:"èªªèµ°å°±èµ°ã€ç¾å ´ä¾å¿ƒæƒ…èª¿æ•´", v:-1}]},
  { id:9, dim:"EI", q:"èªè­˜æ–°æœ‹å‹ï¼š", a:[{t:"å¾ˆå¿«æ‰“æˆä¸€ç‰‡ã€ç¤¾ç‰›åŠ æˆ", v:+1},{t:"æ…¢æ…¢ç†Ÿæ‚‰ã€è³ªé‡é‡æ–¼æ•¸é‡", v:-1}]},
  { id:10, dim:"SN", q:"æˆ€æ„›ä¸­çš„å®‰å…¨æ„Ÿæºè‡ªï¼š", a:[{t:"æ˜ç¢ºæ‰¿è«¾èˆ‡å¯è¦‹æŠ•å…¥", v:+1},{t:"å½¼æ­¤éˆé­‚é »ç‡èˆ‡é»˜å¥‘", v:-1}]},
  { id:11, dim:"TF", q:"é€å°æ–¹ç¦®ç‰©æ™‚ä½ æœƒï¼š", a:[{t:"ç ”ç©¶éœ€æ±‚èˆ‡æ€§åƒ¹æ¯”", v:+1},{t:"è§€å¯ŸTAå–œå¥½ã€æ‰“é€ å°ˆå±¬æ„Ÿ", v:-1}]},
  { id:12, dim:"JP", q:"å®¶å‹™åˆ†å·¥ï¼š", a:[{t:"æ˜ç¢ºè¦å‰‡èˆ‡å›ºå®šç¯€å¥", v:+1},{t:"éš¨æ©Ÿè¼ªæµã€çœ‹ç•¶å¤©ç‹€æ…‹", v:-1}]},
  { id:13, dim:"EI", q:"æ„Ÿæƒ…å‡ºå•é¡Œæ™‚ï¼š", a:[{t:"æ‹‰åˆ°æª¯é¢ä¸Šè¨è«–èˆ‡å”èª¿", v:+1},{t:"å…ˆè‡ªæˆ‘æ¶ˆåŒ–ã€æ‰¾æ™‚æ©Ÿå†èŠ", v:-1}]},
  { id:14, dim:"SN", q:"ç¬¬ä¸€æ¬¡è¦‹å®¶é•·ï¼š", a:[{t:"æ³¨é‡ç´°ç¯€èˆ‡æµç¨‹ã€æŒ‰éƒ¨å°±ç­", v:+1},{t:"ç›¸ä¿¡è‡ªç„¶äº’å‹•ã€é‡è¦–æ°›åœ", v:-1}]},
  { id:15, dim:"TF", q:"å°å¦ä¸€åŠçš„æœŸå¾…ï¼š", a:[{t:"èƒ½åŠ›å¯é ã€åšäº‹æœ‰æ•ˆç‡", v:+1},{t:"é«”è²¼æº«æš–ã€æƒ…ç·’ç©©å®š", v:-1}]},
  { id:16, dim:"JP", q:"è¨‚çµå©šè¨ˆç•«ï¼š", a:[{t:"æ™‚é–“ç·š/é ç®—è¡¨å…ˆå‡ºä¾†", v:+1},{t:"çœ‹ç·£åˆ†ã€é‚Šèµ°é‚Šå®š", v:-1}]},
];

// ====== 16 å‹æè¿°èˆ‡æ¨™ç±¤ ======
const TYPE_INFO = {
  ENFJ:{ name:"æº«æš–é ˜éšŠ", tags:["å…±æƒ…é«˜æ‰‹","ä¸»å‹•çµ¦å®‰å…¨æ„Ÿ","é‡è¦–æ‰¿è«¾"], love:"æ“…é•·å»ºç«‹é•·æœŸé—œä¿‚ï¼Œæœƒä¸»å‹•è¦åŠƒä¸¦ç…§é¡§å°æ–¹æ„Ÿå—ã€‚", match:["INFP","ISFP","INTP"] },
  ENFP:{ name:"éˆæ„Ÿå†’éšªå®¶", tags:["é«˜ç†±æƒ…","é©šå–œè£½é€ æ©Ÿ","é‡è¦–æµªæ¼«"], love:"æƒ…æ„Ÿè¡¨é”è±å¯Œï¼Œå–œæ­¡æ–°é®®èˆ‡é€£çµï¼ŒæœŸç›¼è¢«ç†è§£èˆ‡å…±åŒæˆé•·ã€‚", match:["INFJ","INTJ","ISFJ"] },
  ENTJ:{ name:"è¡Œå‹•æ´¾æŒ‡æ®", tags:["ç›®æ¨™å°å‘","æ•ˆç‡è‡³ä¸Š","å¯é "], love:"åœ¨é—œä¿‚ä¸­æœƒä¸»å‹•è¨­å®šæ–¹å‘èˆ‡ç¯€å¥ï¼Œä½†ä¹Ÿéœ€è¦å½¼æ­¤å°Šé‡ã€‚", match:["INFP","ISFP","ENFP"] },
  ENTP:{ name:"è…¦æ´ç©å®¶", tags:["è¾¯æ€ç‹‚ç†±","å‰µæ–°äº’å‹•","ä¸å–œç„¡èŠ"], love:"éœ€è¦æ€æƒ³ç«èŠ±èˆ‡è‡ªç”±ç©ºé–“ï¼Œæ¬£è³å¥½å¥‡ã€èƒ½å°è©±çš„ä¼´ä¾¶ã€‚", match:["INFJ","ISFJ","INTJ"] },
  ESFJ:{ name:"è²¼å¿ƒç®¡å®¶", tags:["é«”è²¼å‘¨åˆ°","é—œä¿‚ç¶­è­·","å‹™å¯¦"], love:"æ³¨é‡å„€å¼æ„Ÿèˆ‡ç©©å®šç¶“ç‡Ÿï¼Œæ¸´æœ›è¢«è‚¯å®šèˆ‡äº’ç›¸é—œæ‡·ã€‚", match:["ISFP","INFP","ESFP"] },
  ESFP:{ name:"ç¾å ´æ´¾å¿«æ¨‚", tags:["æ°›åœç‹","ç†±æƒ…å³æ™‚","ç¤¾äº¤èƒ½é‡"], love:"åœ¨ç›¸è™•ä¸­æ³¨é‡å¿«æ¨‚é«”é©—èˆ‡é™ªä¼´ï¼Œåæ„›è‡ªç„¶çœŸèª ã€‚", match:["ISFJ","ISTJ","ENFJ"] },
  ESTJ:{ name:"å‹™å¯¦é ˜ç­", tags:["æœ‰åŸå‰‡","å¯é ç©©å®š","é‡æ‰¿è«¾"], love:"è¬›ç©¶åˆ†å·¥å’Œè¨ˆç•«ï¼Œçµ¦è¶³å®‰å…¨æ„Ÿï¼›å¸Œæœ›å½¼æ­¤å®ˆè¦å‰‡ã€‚", match:["ISFP","INFP","ESFP"] },
  ESTP:{ name:"è¡Œå‹•ç¾å¯¦å®¶", tags:["æœæ–·ç›´æ¥","æ„›æŒ‘æˆ°","è‡¨å ´æ„Ÿå¼·"], love:"åæ„›ç›´æ¥æºé€šèˆ‡å…±åŒé«”é©—ï¼Œä¸æ‹–æ³¥å¸¶æ°´ã€‚", match:["ISFJ","INFJ","ESFJ"] },
  INFJ:{ name:"æ´å¯Ÿå¼•å°è€…", tags:["æ·±åº¦é€£çµ","ç†æƒ³ä¸»ç¾©","æº«æŸ”å …å®š"], love:"æ¸´æœ›éˆé­‚å¥‘åˆï¼Œé¡˜æ„é•·æœŸæŠ•å…¥èˆ‡å…±å‰µåƒ¹å€¼ã€‚", match:["ENFP","ENTP","ISFP"] },
  INFP:{ name:"ç†æƒ³æˆ€äºº", tags:["æµªæ¼«ç´”ç²¹","æ„Ÿæ€§ç´°è†©","é‡åƒ¹å€¼è§€"], love:"çœ‹é‡åƒ¹å€¼ä¸€è‡´èˆ‡è¢«ç†è§£ï¼Œæœƒå› æ„›æˆé•·ã€‚", match:["ENFJ","ENTJ","ESFJ"] },
  INTJ:{ name:"æˆ°ç•¥ä¼´ä¾¶", tags:["æ·±è¬€é æ…®","é‚è¼¯æ¸…æ™°","é‡æ•ˆç‡"], love:"åå¥½ç†æ€§äº’å‹•èˆ‡é•·ç·šè¦åŠƒï¼Œéœ€è¦å°Šé‡é‚Šç•Œã€‚", match:["ENFP","ENFJ","ESFP"] },
  INTP:{ name:"æ€è¾¨åˆå¤¥äºº", tags:["ç†æ€§æ¢ç©¶","éœ€è¦ç©ºé–“","çœŸèª "], love:"é‡è¦–æ€æƒ³äº¤æµèˆ‡çœŸå¯¦ï¼Œä¸æ“…è¡¨é¢ç¤¾äº¤ã€‚", match:["ENFJ","ESFJ","ISFJ"] },
  ISFJ:{ name:"æº«æŸ”å®ˆè­·", tags:["ç´°è†©å‹™å¯¦","é‡æ‰¿è«¾","ç©©å®šæº«æš–"], love:"åœ¨æ—¥å¸¸ä¸­é»˜é»˜ä»˜å‡ºï¼ŒæœŸå¾…è¢«çœ‹è¦‹èˆ‡çæƒœã€‚", match:["ENFP","ESFP","ENTP"] },
  ISFP:{ name:"æ„Ÿæ€§è—è¡“å®¶", tags:["è‡ªç”±æ„Ÿ","é«”é©—æ´¾","çœŸèª "], love:"å–œæ­¡è‡ªç„¶ç›¸è™•èˆ‡å½¼æ­¤å°Šé‡ï¼Œæ’æ–¥éåº¦æ§åˆ¶ã€‚", match:["ENFJ","ESTJ","ESFJ"] },
  ISTJ:{ name:"å¯é å¯¦å¹¹å®¶", tags:["æœ‰ç§©åº","å®ˆæ‰¿è«¾","é‡ç´°ç¯€"], love:"é‡è¦–è²¬ä»»èˆ‡ç©©å®šï¼Œæ„›åœ¨ç´°ç¯€èˆ‡è¡Œå‹•ä¸­ã€‚", match:["ENFP","ESFP","INFP"] },
  ISTP:{ name:"å†·éœå¯¦ä½œæ´¾", tags:["ç¨ç«‹","è¡Œå‹•å°å‘","ä¸é»äºº"], love:"å°Šé‡å½¼æ­¤ç©ºé–“èˆ‡å‹™å¯¦äº’å‹•ï¼Œå°‘å»¢è©±å¤šåšäº‹ã€‚", match:["ENFJ","ESFJ","INFJ"] },
};

// ====== ç‹€æ…‹ ======
const state = {
  page: 0, // æ¯é  2 é¡Œ
  perPage: 2,
  answers: {},
  score: {EI:0, SN:0, TF:0, JP:0},
};

// ====== å…ƒç´  ======
const quizEl = document.getElementById('quiz');
const barEl = document.getElementById('bar');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const submitBtn = document.getElementById('submitBtn');
const startBtn = document.getElementById('startBtn');
const againBtn = document.getElementById('againBtn');
const resultEl = document.getElementById('result');
const typeText = document.getElementById('typeText');
const lettersEl = document.getElementById('letters');
const tagsEl = document.getElementById('tags');
const descEl = document.getElementById('desc');
const matchesEl = document.getElementById('matches');
const barsEl = document.getElementById('bars');
const toast = document.getElementById('toast');
const saveBtn = document.getElementById('saveBtn');
const loadBtn = document.getElementById('loadBtn');
const copyLinkBtn = document.getElementById('copyLinkBtn');
const shareBtn = document.getElementById('shareBtn');
const hashInfo = document.getElementById('hashInfo');

function showToast(msg){
  toast.textContent = msg; toast.style.display='block';
  setTimeout(()=> toast.style.display='none', 2200);
}

// ====== é€²åº¦ã€é é¢æ¸²æŸ“ ======
function render(){
  const total = QUESTIONS.length;
  const answered = Object.keys(state.answers).length;
  const pct = Math.round(answered/total*100);
  barEl.style.width = pct + '%';

  const start = state.page * state.perPage;
  const items = QUESTIONS.slice(start, start + state.perPage);
  quizEl.innerHTML = items.map(q => renderQuestion(q)).join('');

  // æ§åˆ¶æŒ‰éˆ•
  prevBtn.disabled = state.page === 0;
  nextBtn.disabled = answered < Math.min(total, (state.page+1)*state.perPage);
  submitBtn.disabled = answered < total;
}

function renderQuestion(q){
  const name = 'q_'+q.id;
  const val = state.answers[q.id];
  return `
    <div class="q">
      <h3>${q.id}. ${q.q}</h3>
      <div class="opt">
        ${q.a.map((opt, idx)=>`<label>
          <input type="radio" name="${name}" value="${opt.v}" ${val==opt.v? 'checked':''} />
          <span>${opt.t}</span>
        </label>`).join('')}
      </div>
      <div class="hint">ç¶­åº¦ï¼š${q.dim}ï¼ˆå·¦é¸é …åæ­£å‘ï¼Œå³é¸é …åè² å‘ï¼‰</div>
    </div>
  `;
}

quizEl.addEventListener('change', (e)=>{
  const target = e.target;
  if(target && target.name && target.type==='radio'){
    const id = Number(target.name.split('_')[1]);
    const q = QUESTIONS.find(x=>x.id===id);
    state.answers[id] = Number(target.value);
    // æ›´æ–° scoreï¼ˆå…ˆé‡ç®—æ›´ç©©å¦¥ï¼‰
    state.score = {EI:0,SN:0,TF:0,JP:0};
    for(const q of QUESTIONS){
      const v = state.answers[q.id];
      if(typeof v === 'number') state.score[q.dim]+= v;
    }
    render();
  }
});

prevBtn.addEventListener('click', ()=>{ state.page = Math.max(0, state.page-1); render(); });
nextBtn.addEventListener('click', ()=>{ state.page = Math.min(Math.ceil(QUESTIONS.length/state.perPage)-1, state.page+1); render(); });
startBtn.addEventListener('click', ()=>{ state.page=0; render(); document.getElementById('app').scrollIntoView({behavior:'smooth'}); });

// ====== è¨ˆç®—çµæœ ======
function sign(x){ return x>0?1:(x<0?-1:0); }
function toType(score){
  const EI = score.EI>=0 ? 'E':'I';
  const SN = score.SN>=0 ? 'S':'N';
  const TF = score.TF>=0 ? 'T':'F';
  const JP = score.JP>=0 ? 'J':'P';
  return EI+SN+TF+JP;
}

submitBtn.addEventListener('click', ()=>{
  const type = toType(state.score);
  showResult(type, state.score);
  const share = encodeShare(type, state.score);
  history.replaceState(null, '', '#'+share);
});

againBtn?.addEventListener('click', ()=>{
  state.page=0; state.answers={}; state.score={EI:0,SN:0,TF:0,JP:0};
  resultEl.hidden=true; render();
});

saveBtn.addEventListener('click', ()=>{
  const type = toType(state.score);
  localStorage.setItem('love_mbti', JSON.stringify({type, score:state.score, t:Date.now()}));
  showToast('âœ… å·²å„²å­˜åˆ°æœ¬æ©Ÿ');
});

loadBtn.addEventListener('click', ()=>{
  const raw = localStorage.getItem('love_mbti');
  if(!raw) return showToast('å°šç„¡å·²å„²å­˜çµæœ');
  try{ const data = JSON.parse(raw); showResult(data.type, data.score); }catch{ showToast('è¼‰å…¥å¤±æ•—'); }
});

copyLinkBtn.addEventListener('click', ()=>{
  const url = location.href;
  navigator.clipboard.writeText(url).then(()=> showToast('ğŸ”— å·²è¤‡è£½çµæœé€£çµ')).catch(()=> showToast('ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é¸å–ç¶²å€åˆ—'));
});

shareBtn.addEventListener('click', ()=>{
  navigator.clipboard.writeText(location.href).then(()=> showToast('å·²è¤‡è£½æœ¬é é€£çµï¼Œå¿«åˆ†äº«çµ¦æœ‹å‹ï¼'));
});

// ====== é¡¯ç¤ºçµæœ ======
function showResult(type, score){
  const info = TYPE_INFO[type] || {name:'æœªå®šç¾©', tags:[], love:'', match:[]};
  typeText.textContent = type + ' Â· ' + info.name;
  lettersEl.innerHTML = letterPills(type, score);
  tagsEl.innerHTML = info.tags.map(t=> `<div class="pill">#${t}</div>`).join('');
  descEl.innerHTML = `<p><strong>æˆ€æ„›å‚¾å‘ï¼š</strong>${info.love}</p>`;
  matchesEl.innerHTML = info.match.map(t=> `<div class="pill">${t}</div>`).join('');
  barsEl.innerHTML = renderBars(score);
  resultEl.hidden = false;
  document.getElementById('result').scrollIntoView({behavior:'smooth'});
}

function letterPills(type, score){
  const dims = [['E','I','EI'],['S','N','SN'],['T','F','TF'],['J','P','JP']];
  return dims.map(([L,R,key])=>{
    const v = score[key];
    const left = Math.max(0, (v+4)/8*100); // -4..+4 å°æ‡‰ 0..100 ç²—ç•¥è¦–è¦º
    return `<div class="pill" title="${key}: ${v}">
      <strong>${type.includes(L)?L:R}</strong> / ${L}${R}
    </div>`;
  }).join('');
}

function renderBars(score){
  const items = [
    {k:'EI', l:'E', r:'I', v:score.EI},
    {k:'SN', l:'S', r:'N', v:score.SN},
    {k:'TF', l:'T', r:'F', v:score.TF},
    {k:'JP', l:'J', r:'P', v:score.JP},
  ];
  return items.map(it=>{
    const percent = Math.round((it.v+4)/8*100); // -4..+4 -> 0..100
    return `<div style="margin:10px 0">
      <div class="muted">${it.k}: ${it.l} â†” ${it.r}ï¼ˆ${it.v}ï¼‰</div>
      <div class="progress"><div style="width:${percent}%"></div></div>
    </div>`;
  }).join('');
}

// ====== åˆ†äº«ï¼é€£çµé‚„åŸ ======
function encodeShare(type, score){
  const payload = {t:type, s:score};
  const str = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
  return str;
}
function decodeShare(hash){
  try{
    const obj = JSON.parse(decodeURIComponent(escape(atob(hash))));
    return obj;
  }catch{ return null }
}

// å¦‚ç¶²å€å¸¶ hashï¼Œè‡ªå‹•é‚„åŸ
(function(){
  const h = location.hash.replace('#','');
  if(h){
    const data = decodeShare(h);
    if(data && data.t && data.s){ showResult(data.t, data.s); hashInfo.textContent = 'å·²å¾ç¶²å€é‚„åŸçµæœï¼š'+data.t; }
    else hashInfo.textContent = 'åµæ¸¬åˆ°åˆ†äº«ä»£ç¢¼ï¼Œä½†è§£æå¤±æ•—ã€‚';
  }else{
    hashInfo.textContent = 'å°æŠ€å·§ï¼šå®Œæˆå¾Œæœƒç”Ÿæˆå¯åˆ†äº«çš„ç¶²å€ã€‚';
  }
})();

// åˆå§‹åŒ–
render();
</script>
</body>
</html>
